# in situ 4D-STEM Analysis of Polycrystal Grain Evolution
  
This is the analysis code for in situ 4D-STEM datasets focusing on the evolution of polycrystal grain orientation and morphology.  
The analysis was performed in the following sequence: a) crystal orientation indexing, b) grain segmentation, c) matching grains in different frames, and d) accumulation of statistics and visualization.  
(a) Crystal orientation indexing:  
The 4D-STEM dataset in block file format was imported using the hyperspy package. Orientation indexing involved the following steps: generating a simulated diffraction pattern library for Pt using the diffsims package, matching each experimental nanobeam electron diffraction (NBED) pattern with simulation patterns in the library using cross-correlation, and selecting the best match result as the indexed orientation for each pixel with its corresponding NBED pattern.  
The diffraction pattern library was generated with an angle interval of 1˚. To match the experimental NBED pattern, the reciprocal space resolution of the simulation patterns was set to 0.0218 pixel/Å, with an acceleration voltage of 200 kV. The simulated library was used to index the experimental NBED patterns via the pyxem package. The indexing confidence was defined as the value of the normalized cross-correlation of the diffraction template with the NBED pattern.
  
(b) Grain segmentation:  
Grain segmentation was conducted using non-negative matrix factorization (NMF). Unlike traditional methods such as hierarchical clustering or minimum spanning tree, NMF does not require prior knowledge of local orientation. This is advantageous because traditional methods can propagate errors caused by mis-indexed local orientations, which often occur due to limited data quality. NMF automatically identifies and clusters similar NBED patterns, avoiding these error propagation issues. NMF has been shown to work well on 4D-STEM datasets for grain segmentation. Another advantage of NMF is its ability to determine grain locations and areas regardless of grain overlapping. In the case of nanocrystalline films, where initial grain size is smaller than the film thickness and grains overlap near grain boundaries (GBs), traditional methods that assign pixels to only one grain are not suitable. Therefore, NMF is applied for grain segmentation.  
One disadvantage of NMF for grain segmentation is its longer computational time. The complexity of NMF is (nm)^O(2rr2), where n is the number of factors, m is the number of loadings, and r is the amount of data for segmentation. For the 4D-STEM dataset with 400x400 pixels and initially ~2000 grains, the NMF segmentation time is too long and difficult to estimate. To decrease the complexity, the dataset is divided into 25 smaller 80x80 datasets, and NMF is performed on each split dataset. Grains near the dividing lines are removed, and the segmented grains from each small dataset are recombined. The process is repeated by shifting the dividing lines to recover the grains near the cutting lines. Duplicated grains are identified by cross-correlation of loading and factor matrices with those of other grains. Grain locations are determined by thresholding the loading map of each grain. After these processes, most grains are recognized in the 4D-STEM dataset.
  
(c) Matching the grains in different frames:  
Before finding the same grains in different frames, drift and scanning distortion of the 4D-STEM dataset need to be corrected. Assuming uniform distortion, affine transformations are applied to correct drift and distortion. Virtual dark field (VDF) images of the dataset are obtained, and features in the VDF images are detected using a scale-invariant feature transform (SIFT) detector from the openCV package. Feature points in different images are matched to obtain affine transformation matrices for drift and distortion correction. The affine transformations are then applied to align all 4D-STEM datasets.  
The same grains in different frames are linked as a chain, with grains having the closest center of mass determined as the same grain. To account for grain disappearance during in situ experiments, all grains in the last frame of the dataset are registered first, and then the tracking is performed frame by frame. Grain chain objects are created to store information about the grains in different frames. Supplementary Fig. 2 illustrates the stored information, including grain morphology and orientations. It should be noted that grain orientation is reindexed based on the averaged diffraction patterns of the same grains during this process.
  
(d) Statistics and visualization:  
With the information of each grain at each time frame, statistical analysis is conducted to examine the changes in grain size and orientation. By comparing the relevant quantities at different frames, the change in grain size and orientation for each grain is determined. Since these properties are stored together for each grain, the correlation between them is established by thresholding the misorientation values. After extracting the relevant information, the data is visualized in histogram form.
